import random

menu = """
[c] Cadastrar usuário
[a] Cadastrar Conta
[d] Depositar
[s] Sacar
[e] Extrato
[q] Sair

=> """

LIMITE_SAQUES = 3
LIMITE_VALOR_SAQUE = 500
AGENCIA = "0001"

usuarios = []
contas = []

def saque(*, saldo, valor, extrato, limite_saques, limite_v, numero_saques, cpf, agencia, numero_conta):
    if valor > saldo:
        print("Operação falhou! Saldo insuficiente!")
    elif valor > limite_v:
        print("Operação falhou! Limite de valor excedido!")
    elif valor <= saldo:
        saldo -= valor
        extrato += f"Saque: R$ {valor:.2f}\nSaldo: R$ {saldo}\n"
        numero_saques += 1
        print("Saque realizado com sucesso!")
    return saldo, extrato, numero_saques

def deposito(saldo, valor, extrato, cpf, agencia, numero_conta):
    if valor > 0:
        saldo += valor
        extrato += f"Depósito: R$ {valor:.2f}\nSaldo: R$ {saldo}\n"
        print("Depósito realizado com sucesso!")
    else:
        print("Operação falhou! O valor informado é inválido.")
    return saldo, extrato

def extrato(extrato, /, *, saldo, numero_conta):
    print("-----------------------------")
    print(f"Extrato da conta {numero_conta}")
    print(extrato if extrato else "Nenhuma movimentação.")
    print(f"Saldo atual: R$ {saldo:.2f}")
    print("-----------------------------")

def criar_usuario(nome, data_nascimento, cpf, endereco):
    for usuario in usuarios:
        if usuario["cpf"] == cpf:
            print("Já existe um usuário cadastrado com esse CPF!")
            return
    usuarios.append({"nome": nome, "data_nascimento": data_nascimento, "cpf": cpf, "endereco": endereco})
    print("Usuário cadastrado com sucesso!\n")

def criar_conta(agencia, usuario):
    numero_conta = random.randint(100000, 999999)
    conta = {
        "agencia": agencia,
        "numero_conta": numero_conta,
        "usuario": usuario,
        "saldo": 0,
        "extrato": "",
        "saques": 0
    }
    contas.append(conta)
    print("Conta criada com sucesso!\n")
    print("-----------------------------")
    print("Agência:", agencia)
    print("Número da conta:", numero_conta)
    print("-----------------------------\n")
    return conta

def buscar_conta(numero_conta):
    for conta in contas:
        if str(conta["numero_conta"]) == str(numero_conta):
            return conta
    return None

while True:
    opcao = input(menu)

    if opcao == "c":
        nome = input("Digite o nome do usuário: ")
        data_nascimento = input("Digite a data de nascimento do usuário: ")
        cpf = input("Digite o cpf do usuário: ")
        endereco = input("Digite o endereço do usuário: ")
        criar_usuario(nome, data_nascimento, cpf, endereco)

    elif opcao == "a":
        cpf = input("Digite o CPF do usuário: ")
        usuario = None
        for u in usuarios:
            if u["cpf"] == cpf:
                usuario = u
                break
        if usuario:
            criar_conta(AGENCIA, usuario)
        else:
            print("Usuário não encontrado! Cadastre o usuário primeiro.")

    elif opcao == "d":
        numero_conta = input("Digite o número da conta: ")
        conta = buscar_conta(numero_conta)
        if not conta:
            print("Conta não encontrada!")
            continue
        valor = float(input("Informe o valor do depósito: "))
        conta["saldo"], conta["extrato"] = deposito(
            saldo=conta["saldo"],
            valor=valor,
            extrato=conta["extrato"],
            cpf=conta["usuario"]["cpf"],
            agencia=conta["agencia"],
            numero_conta=conta["numero_conta"]
        )

    elif opcao == "s":
        numero_conta = input("Digite o número da conta: ")
        conta = buscar_conta(numero_conta)
        if not conta:
            print("Conta não encontrada!")
            continue
        if conta["saques"] >= LIMITE_SAQUES:
            print("Limite de saques atingido!")
            continue
        valor = float(input("Informe o valor do saque: "))
        conta["saldo"], conta["extrato"], conta["saques"] = saque(
            saldo=conta["saldo"],
            valor=valor,
            extrato=conta["extrato"],
            limite_saques=LIMITE_SAQUES,
            limite_v=LIMITE_VALOR_SAQUE,
            numero_saques=conta["saques"],
            cpf=conta["usuario"]["cpf"],
            agencia=conta["agencia"],
            numero_conta=conta["numero_conta"]
        )

    elif opcao == "e":
        numero_conta = input("Digite o número da conta: ")
        conta = buscar_conta(numero_conta)
        if not conta:
            print("Conta não encontrada!")
            continue
        extrato(
            conta["extrato"],
            saldo=conta["saldo"],
            numero_conta=conta["numero_conta"]
        )

    elif opcao == "q":
        print("Sistema finalizado com sucesso!")
        break

    else:
        print("Operação inválida, por favor selecione novamente a operação desejada.")
